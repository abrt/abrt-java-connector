#!/bin/sh
make $1
EC=$?

if [ $EC -ne $2 ]; then
    echo "Expected exit code $2 but got $EC"
    exit 1
fi

TMP_RESULT=`mktemp /tmp/abrt_java_connector.XXXXXXX`
JAVA_RTLIB_PATH=`sed -n "s/^.*\(jar:file:\)\(.*\)\(\/rt.jar\!.*\).*$/\2/p" $4 | head -1`

if [ -n "$JAVA_RTLIB_PATH" ]; then
    sed "s,"$JAVA_RTLIB_PATH",JAVA_AND_SYSTEM_SPECIFIC_PATH," $4 > $TMP_RESULT
    sed -i "s/\(\.java:\)[0-9]\+\() \[.*JAVA_AND_SYSTEM_SPECIFIC_PATH\)/\1LINENO\2/" $TMP_RESULT
else
    rm -f $TMP_RESULT
    TMP_RESULT=$4
fi

diff -u $3 $TMP_RESULT
EC=$?

if [ 0 -ne $EC ]; then
    echo "Expected $3 differs from result $TMP_RESULT(origin $4)"
    exit 1
fi

rm -f $TMP_RESULT
exit 0
